<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}"
	  th:with="title=${bookForm.id == null or bookForm.id == 0 ? 'Nuovo Libro' : 'Modifica Libro'}">>

<div layout:fragment="content">
  <div class="card h-100 border p-3">

    <!-- Titolo pagina -->
    <h1 th:text="${bookForm.id == null or bookForm.id == 0 ? 'Nuovo Libro' : 'Modifica Libro'}"></h1>

    <!-- FORM UNIFICATO PER NEW ED EDIT -->
    <form th:object="${bookForm}"
          th:action="${bookForm.id == null or bookForm.id == 0} ? @{/books/new} : @{/books/edit/{id}(id=${bookForm.id})}"
          method="post"
          enctype="multipart/form-data">	  
		  
      <input type="hidden" th:field="*{id}" />

      <!-- Campi base -->
      <div class="mb-3">
        <label class="form-label">Titolo</label>
        <input type="text" th:field="*{title}" class="form-control" required />
		<div class="text-danger" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
      </div>
      <div class="mb-3">
        <label class="form-label">Anno Pubblicazione</label>
        <input type="number" th:field="*{publicationYear}" class="form-control" required />
		<div class="text-danger" th:if="${#fields.hasErrors('publicationYear')}" th:errors="*{publicationYear}"></div>
      </div>
      <div class="mb-3">
        <label class="form-label">Autori</label>
        <div class="d-flex flex-wrap">
          <div th:each="aut : ${allAuthors}" class="form-check me-3 mb-2">
            <input type="checkbox"
                   class="form-check-input"
                   th:field="*{authorIds}"
                   th:value="${aut.id}"
                   th:id="${'chk-aut-' + aut.id}" />
            <label class="form-check-label"
                   th:for="${'chk-aut-' + aut.id}"
                   th:text="${aut.firstName + ' ' + aut.lastName}"></label>
          </div>
        </div>
      </div>

      <!-- Selezione nuove immagini -->
      <div class="mb-3">
        <label class="form-label">Seleziona Immagini</label>
        <input type="file"
			   accept="image/*"
               id="imagesInput"
               name="images"
               multiple
               class="form-control" />
        <small class="form-text text-muted">Anteprima e seleziona copertina dalle nuove.</small>
      </div>

      <!-- Anteprima nuove immagini -->
      <div class="mb-3">
        <div id="previewContainer" class="d-flex flex-wrap gap-2"></div>
      </div>
      <div class="mb-3" id="coverOptions"></div>

      <!-- Immagini già caricate -->
      <div class="mt-4" th:if="${book != null and not #lists.isEmpty(book.images)}">
        <p>Immagini già caricate:</p>
        <div class="d-flex flex-wrap">
          <div th:each="img : ${book.images}"
               class="position-relative me-2 mb-2"
               style="width:100px;">
            <img th:src="@{/books/{b}/images/{i}(b=${book.id},i=${img.id})}"
                 class="img-thumbnail"
                 style="width:100%;height:100px;object-fit:cover;" />

				 <div class="position-absolute top-0 end-0 p-1">
				   <button type="button"
				           class="btn btn-sm btn-danger"
				           th:onclick="'submitImageDelete(' + ${book.id} + ',' + ${img.id} + ')'">
				     <i class="bi bi-trash"></i>
				   </button>
				 </div>

            <div class="form-check mt-1 text-center">
				<input type="radio"
				       th:field="*{existingCoverImageId}"
				       th:value="${img.id}"
				       class="form-check-input" />
               <label class="form-check-label text-muted small">Scegli come copertina?</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Salva / Annulla -->
      <button type="submit" class="btn btn-primary" th:text="${bookForm.id == null or bookForm.id == 0 ? 'Crea' : 'Salva'}"></button>
      <a th:href="@{/books}" class="btn btn-secondary ms-2">Annulla</a>
    </form>

  </div>

  <!-- SCRIPT PREVIEW & COVER -->
  <script th:inline="javascript">
  /*<![CDATA[*/
  document.addEventListener('DOMContentLoaded', () => {
    const input      = document.getElementById('imagesInput');
    const preview    = document.getElementById('previewContainer');
    const coverOpts  = document.getElementById('coverOptions');

    if (!input || !preview || !coverOpts) return;

    let currentFiles = [];
    let lastNewRadio = null;

    input.addEventListener('change', () => {
      const newFiles = Array.from(input.files);

      for (const file of newFiles) {
        if (!currentFiles.some(f => f.name === file.name && f.size === file.size)) {
          currentFiles.push(file);
        }
      }

      renderPreviews();
    });

    function renderPreviews() {
      const transfer = new DataTransfer();
      currentFiles.forEach(file => transfer.items.add(file));
      input.files = transfer.files;

      preview.innerHTML = '';
      coverOpts.innerHTML = '';

      currentFiles.forEach((file, idx) => {
        const url = URL.createObjectURL(file);

        const wrap = document.createElement('div');
        wrap.style.cssText = 'position:relative;display:inline-block;margin:0.25rem;width:100px;height:100px;';

        const img = document.createElement('img');
        img.src = url;
        img.onload = () => URL.revokeObjectURL(url);
        img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
        img.classList.add('img-thumbnail');
        wrap.appendChild(img);

        // bottone X
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = '×';
        Object.assign(btn.style, {
          position: 'absolute',
          top: '0',
          right: '0',
          background: 'rgba(255,255,255,0.8)',
          border: 'none',
          color: 'red',
          fontSize: '1.4rem',
          lineHeight: '1',
          padding: '0',
          cursor: 'pointer',
          zIndex: '10'
        });
        btn.title = 'Rimuovi';

        btn.addEventListener('click', () => {
          const removedFile = currentFiles[idx];
          currentFiles = currentFiles.filter(f => f !== removedFile);
          if (lastNewRadio && lastNewRadio.value == idx.toString()) {
            lastNewRadio = null;
          }
          renderPreviews();
        });

        wrap.appendChild(btn);
        preview.appendChild(wrap);

        // radio copertina (una sola tra nuove e vecchie)
        const radioWrap = document.createElement('div');
        radioWrap.classList.add('form-check', 'mt-1');

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'newCoverIndex';
        radio.value = idx;
        radio.id = `new-cover-${idx}`;
        radio.classList.add('form-check-input');

        const lbl = document.createElement('label');
        lbl.htmlFor = radio.id;
		lbl.textContent = 'Scegli come copertina?';
		lbl.classList.add('form-check-label', 'ms-1', 'text-muted', 'small');
		lbl.style.display = 'block';

        radio.addEventListener('click', function (e) {
          if (lastNewRadio === this) {
			this.checked = false;          
            lastNewRadio = null;           
          } else {
            lastNewRadio = this;          

            // deseleziona eventuale immagine esistente
            const existing = document.querySelector('input[name="existingCoverImageId"]:checked');
            if (existing) existing.checked = false;
          }
        });

        radioWrap.append(radio, lbl);
        coverOpts.appendChild(radioWrap);
      });
    }

    // disattiva la radio tra le nuove se seleziono una esistente
    document.querySelectorAll('input[name="existingCoverImageId"]').forEach(radio => {
      radio.addEventListener('click', () => {
        if (lastNewRadio) {
          lastNewRadio.checked = false;      
          lastNewRadio = null;
        }
      });
    });
  });
  
  window.submitImageDelete = function(bookId, imageId) {
    if (!confirm('Vuoi davvero eliminare questa immagine?')) return;

    fetch(`/books/${bookId}/images/${imageId}`, {
      method: 'DELETE',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => {
      if (response.ok) {
        // rimuove il div che contiene l'immagine eliminata
        const button = document.querySelector(`button[onclick="submitImageDelete(${bookId},${imageId})"]`);
        const container = button?.closest('.position-relative');
        if (container) container.remove();
      } else {
        alert('Errore durante l\'eliminazione dell\'immagine.');
      }
    })
    .catch(err => {
      console.error('Errore durante la richiesta DELETE:', err);
      alert('Errore di rete durante l\'eliminazione.');
    });
  };
  
  const maxSize = 2 * 1024 * 1024; // 2MB

  input.addEventListener('change', () => {
    const newFiles = Array.from(input.files);

    for (const file of newFiles) {
      if (file.size > maxSize) {
        alert(`Il file "${file.name}" supera i 2MB consentiti.`);
        continue; 
      }

      if (!currentFiles.some(f => f.name === file.name && f.size === file.size)) {
        currentFiles.push(file);
      }
    }

    renderPreviews();
  });

  /*]]>*/
  </script>


</div>
</html>